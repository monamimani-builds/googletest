name: CI

on:
  workflow_dispatch:
  push:
    branches: [ master ]

jobs:
  build:
    runs-on:  windows-2019

    strategy:
      matrix:
        BuidType: [Debug, RelWithDebInfo]

    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: Cmake generate
        run: |
          
          $vswherePath="%ProgramFiles(x86)%\Microsoft Visual Studio\Installer\vswhere.exe"
          Write-Output $vswherePath
          $installDir = "$vswherePath" -latest -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath
          $vcvarallPath = join-path $installDir 'VC\Auxiliary\Build\vcvarsall.bat'
          
          if(not test-path $vcvarallPath) (
            exit /b 2
          )

          & $vcvarallPath x64
          cmake.exe -S googletest -Wno-dev -B _build -D CMAKE_INSTALL_PREFIX=_install -D CMAKE_BUILD_TYPE=Debug;RelWithDebInfo -D CMAKE_CXX_COMPILER="cl.exe" -D CMAKE_C_COMPILER="cl.exe" -D MSVC_TOOLSET_VERSION=142 -D BUILD_GMOCK=TRUE -D BUILD_SHARED_LIBS=TRUE -D INSTALL_GTEST=TRUE -G "Ninja"
      
      - name: Cmake build/install
        run: |
          cmake --build ./_build --target install --config ${{ matrix.BuidType }}
